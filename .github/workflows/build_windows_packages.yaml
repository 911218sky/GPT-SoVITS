name: Build and Upload Windows Package

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Date suffix (optional)"
        required: false
        default: ""
      suffix:
        description: "Package name suffix (optional)"
        required: false
        default: ""
      hf_repo:
        description: "HuggingFace repo for packages (e.g. sky1218/GPT-SoVITS-Packages)"
        required: false
        default: "sky1218/GPT-SoVITS-Packages"
      ms_repo:
        description: "ModelScope repo for packages (e.g. sky1218/GPT-SoVITS-Packages)"
        required: false
        default: "sky1218/GPT-SoVITS-Packages"
      hf_models_repo:
        description: "HuggingFace repo for models cache (e.g. sky1218/GPT-SoVITS-Models)"
        required: false
        default: "sky1218/GPT-SoVITS-Models"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        torch_cuda: [cu126, cu128, cu129, cu130]
    env:
      TORCH_CUDA: ${{ matrix.torch_cuda }}
      DATE_SUFFIX: ${{ github.event.inputs.date }}
      PKG_SUFFIX: ${{ github.event.inputs.suffix }}
      HF_REPO: ${{ github.event.inputs.hf_repo }}
      MS_REPO: ${{ github.event.inputs.ms_repo }}
      HF_MODELS_REPO: ${{ github.event.inputs.hf_models_repo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Package
        shell: pwsh
        env:
          TORCH_CUDA: ${{ matrix.torch_cuda }}
          PKG_SUFFIX: ${{ github.event.inputs.suffix }}
          DATE_SUFFIX: ${{ github.event.inputs.date }}
        run: ./.github/build_windows_packages.ps1

      - name: Move Package to Workspace
        shell: pwsh
        run: |
          Move-Item ../*.tar.zst ./

      - name: Generate package info
        id: pkg
        shell: pwsh
        run: |
          $date = "${{ github.event.inputs.date }}"
          if ([string]::IsNullOrWhiteSpace($date)) { $date = Get-Date -Format "MMdd" }
          $suffix = "${{ github.event.inputs.suffix }}"
          $pkgName = "GPT-SoVITS-$date$suffix-${{ matrix.torch_cuda }}"
          echo "name=$pkgName" >> $env:GITHUB_OUTPUT
          echo "date=$date" >> $env:GITHUB_OUTPUT
          echo "suffix=$suffix" >> $env:GITHUB_OUTPUT

      - name: Upload to Hugging Face and ModelScope (Parallel)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          MS_TOKEN: ${{ secrets.MS_TOKEN }}
        shell: pwsh
        run: |
          pip install huggingface_hub modelscope -q
          $file = Get-Item "*.tar.zst"
          $fileName = $file.Name
          
          # Create temp folder for ModelScope
          New-Item -ItemType Directory -Force -Path "ms_upload" | Out-Null
          Copy-Item $fileName "ms_upload/"
          
          # Start HuggingFace upload in background
          Write-Host "[INFO] Starting parallel uploads..."
          $hfJob = Start-Job -ScriptBlock {
            param($fileName, $hfRepo)
            $env:HF_TOKEN = $using:env:HF_TOKEN
            Set-Location $using:PWD
            Write-Host "Uploading $fileName to Hugging Face..."
            python scripts/upload_to_hf.py $fileName $hfRepo
          } -ArgumentList $fileName, "${{ env.HF_REPO }}"
          
          # Start ModelScope upload in background (if token exists)
          $msJob = $null
          if (-not [string]::IsNullOrWhiteSpace("$env:MS_TOKEN")) {
            $msJob = Start-Job -ScriptBlock {
              param($fileName, $msRepo)
              $env:MS_TOKEN = $using:env:MS_TOKEN
              Set-Location $using:PWD
              Write-Host "Uploading $fileName to ModelScope..."
              python -c @"
          import os
          from modelscope.hub.api import HubApi
          
          api = HubApi()
          api.login(os.environ['MS_TOKEN'])
          
          try:
              api.upload_folder(
                  repo_id='$msRepo',
                  folder_path='ms_upload',
                  revision='master',
                  commit_message='Upload $fileName'
              )
              print('[INFO] Uploaded $fileName to ModelScope')
          except Exception as e:
              print(f'[WARN] ModelScope upload failed: {e}')
          "@
            } -ArgumentList $fileName, "${{ env.MS_REPO }}"
          } else {
            Write-Host "[WARN] MS_TOKEN not set, skipping ModelScope upload"
          }
          
          # Wait for all jobs to complete
          Write-Host "[INFO] Waiting for uploads to complete..."
          $hfResult = Receive-Job -Job $hfJob -Wait -AutoRemoveJob
          Write-Host $hfResult
          
          if ($msJob) {
            $msResult = Receive-Job -Job $msJob -Wait -AutoRemoveJob
            Write-Host $msResult
          }
          
          Write-Host "[INFO] All uploads completed!"

      - name: Save Release Info
        shell: pwsh
        run: |
          $pkgName = "${{ steps.pkg.outputs.name }}"
          $date = "${{ steps.pkg.outputs.date }}"
          $suffix = "${{ steps.pkg.outputs.suffix }}"
          $content = "$pkgName`n$date`n$suffix"
          $content | Out-File -FilePath "release_info_${{ matrix.torch_cuda }}.txt" -Encoding UTF8

      - name: Upload Release Info
        uses: actions/upload-artifact@v4
        with:
          name: release_info_${{ matrix.torch_cuda }}
          path: release_info_${{ matrix.torch_cuda }}.txt

  release:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    env:
      HF_REPO: ${{ github.event.inputs.hf_repo || 'sky1218/GPT-SoVITS-Packages' }}
      MS_REPO: ${{ github.event.inputs.ms_repo || 'sky1218/GPT-SoVITS-Packages' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Release Info
        uses: actions/download-artifact@v4
        with:
          pattern: release_info_*
          path: release_infos
          merge-multiple: true

      - name: Generate Release Body
        id: body
        run: |
          echo "## GPT-SoVITS Windows Package" > release_body.md
          echo "" >> release_body.md
          echo "This release contains the Windows package for GPT-SoVITS." >> release_body.md
          echo "" >> release_body.md
          echo "### ðŸ“¥ Download Options" >> release_body.md
          echo "" >> release_body.md
          echo "| Package | Hugging Face | ModelScope | ModelScope Mirror |" >> release_body.md
          echo "|---------|--------------|------------|-------------------|" >> release_body.md

          TAG_NAME=""
          for file in release_infos/release_info_*.txt; do
            NAME=$(sed '1q;d' "$file" | tr -d '\r')
            DATE=$(sed '2q;d' "$file" | tr -d '\r')
            SUFFIX=$(sed '3q;d' "$file" | tr -d '\r')
            
            if [ -z "$TAG_NAME" ]; then
                TAG_NAME="v${DATE}${SUFFIX}"
            fi
            
            HF_LINK="https://huggingface.co/${{ env.HF_REPO }}/resolve/main/${NAME}.tar.zst"
            MS_LINK="https://www.modelscope.cn/models/${{ env.MS_REPO }}/resolve/master/${NAME}.tar.zst"
            MS_MIRROR_LINK="https://github.sky1218.com/modelscope/models/${{ env.MS_REPO }}/resolve/master/${NAME}.tar.zst"
            echo "| ${NAME}.tar.zst | [â¬‡ï¸ HuggingFace]($HF_LINK) | [â¬‡ï¸ ModelScope]($MS_LINK) | [â¬‡ï¸ Mirror]($MS_MIRROR_LINK) |" >> release_body.md
          done

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          echo "" >> release_body.md
          echo "### ðŸ“‹ Included Models" >> release_body.md
          echo "- All Pretrained Models (GPT-SoVITS)" >> release_body.md
          echo "- FunASR Models (VAD, Punctuation, ASR)" >> release_body.md
          echo "- G2PW Model" >> release_body.md
          echo "- UVR5 Models" >> release_body.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.body.outputs.tag_name }}
          name: GPT-SoVITS ${{ steps.body.outputs.tag_name }}
          body_path: release_body.md
          draft: false
          prerelease: false
